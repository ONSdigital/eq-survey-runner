{% extends theme('layouts/_survey.html') %}

{% block page_title %}Survey{% endblock %}

{% block main %}

<div class="grid">
  <div class="grid__col col-8@m">
    <div class="u-mb-xs">
      <a class="mars" href="{{previous_location}}">Previous</a>
    </div>
    <br/>
    {% set state = content %}

    {% set all_errors = state.get_errors().items() %}

    {% if all_errors %}

      <div class="u-mb-s u-mb-l@s">
        <div class="alert alert--error">
          <div class="alert__header">
            <h1 class="alert__title venus">This page has {{all_errors|length}} errors</h1>
          </div>
          <div class="alert__body">
            <p class="mars">These <strong>must be corrected</strong> to continue.</p>
            <ul class="list list--bare">
              {% for item_id, errors in all_errors %}
                {% set loop_index = loop.index %}
                {% if errors %}
                {% for error in errors %}
                <li class="list__item mars">
                  {{loop_index}}) <a class="js-inpagelink" href="#{{item_id}}">{{ error }}</a>
                </li>
                {% endfor %}
                {% endif %}
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>

    {% endif %}

    <form action="" class="form qa-questionnaire-form" role="form" method="POST" novalidate>

        {% set group = state.schema_item.container %}

          <div class="group" id="{{group.id}}">

          {% set block = state.schema_item %}

            <div class="block" id="{{block.id}}">

            {% for section in state.children %}
                <div class="section" id="{{section.id}}">
                  {% if section.schema_item.title %}
                    <h1 class="section__title saturn">{{section.schema_item.title}}</h1>
                  {% endif %}
                  {% if section.schema_item.description %}
                    <div class="section__description mars">{{section.schema_item.description|safe}}</div>
                  {% endif %}

                  {% for question in section.questions %}
                    {% if not question.skipped %}
                      {% import 'macros/helpers.html' as helpers %}

                        {% set invalid = question.is_valid == False %}

                        {% set question_title = question.schema_item.title %}
                        {% set question_subtitle = question.schema_item.subtitle %}

                        {% set question_titles %}
                          {%- if question_title -%}
                            <h2 class="question__title neptune">{{question_title}}</h2>
                          {%- endif %}
                          {%- if question_subtitle -%}
                            <br />
                            <h3 class="question__subtitle mars">{{question_subtitle}}</h3>
                          {%- endif %}
                        {% endset %}

                        {% set question_description %}
                          {%- if question.schema_item.description %}
                            <div class="question__description mars" id="description-{{question.id}}">
                              {{question.schema_item.description|safe}}
                            </div>
                          {% endif %}
                        {% endset %}

                        {% set question_answers %}
                         <div class="question__answers">
                             {%- for answer in question.answers -%}
                              <div class="question__answer">
                               {% import 'macros/helpers.html' as helpers %}

                                    {% set invalid = answer.is_valid == False %}

                                    <div class="answer answer--{{answer.schema_item.type|lower}} {{'js-has-errors' if invalid}}" id="{{answer.id}}">

                                      {%- set answer_guidance %}
                                        {% if answer.schema_item.guidance %}
                                          {% include 'partials/guidance.html' %}
                                        {% endif %}
                                      {% endset -%}

                                      {%- set answer_fields %}
                                        <div class="answer__fields js-fields">
                                          {% if answer.schema_item.display and answer.schema_item.display.properties %}
                                            {% set use_grid = answer.schema_item.display.properties.columns %}
                                          {% endif %}
                                            <div class="field field--radio {{'field--cols' if use_grid}}">
                                              <fieldset>
                                                <legend class="u-vh">{{question_title}}</legend>
                                                    {% set label = {
                                                      'for': answer.id,
                                                      'text': answer.label
                                                    } %}
                                                    {% include 'partials/forms/label.html' %}
                                                    {% for option in widget.options %}

                                                      {% set option_id = answer.id ~ "-" ~ loop.index %}

                                                      {% set input = {
                                                        "class": "input input--" ~ widget.type ~ " js-focusable",
                                                        "type": widget.type,
                                                        "value": option.value,
                                                        "name": answer.name,
                                                        "id": option_id,
                                                        "checked": "checked" if option.selected,
                                                        "data-qa": "has-other-option" if option.other
                                                      } %}

                                                      {% set label = {
                                                        "class": "label label--inline venus",
                                                        "for": option_id
                                                      } %}

                                                      <div class="field__item js-focusable-box">

                                                        <input {{input|xmlattr}}>
                                                        <label {{label|xmlattr}}>
                                                          {{option.label}}
                                                          {% if option.description %}
                                                            <br />
                                                            <span class="label__description label__inner pluto">{{option.description|safe}}</span>
                                                          {% endif %}
                                                        </label>

                                                        {% if option.other %}

                                                          {% set other_label = {
                                                            "class": "label mercury",
                                                            "for": option_id ~ "-other"
                                                          } %}

                                                          {% set other_input = {
                                                            "class": "input js-focusable",
                                                            "type": "text",
                                                            "name": answer.name,
                                                            "id": option_id ~ "-other",
                                                            "value": option.other_value,
                                                            "data-qa": "other-option"
                                                          } %}

                                                          <div class="field__other">
                                                            <label {{other_label|xmlattr}}>{{option.other.label}}</label>
                                                            <input {{other_input|xmlattr}}>
                                                          </div>

                                                        {% endif %}

                                                      </div>

                                                    {% endfor %}

                                              </fieldset>
                                            </div>

                                        </div>
                                      {% endset -%}

                                      {% if invalid %}

                                        <div class="alert alert--simple alert--error">
                                          <div class="alert__header">
                                            {% if answer.errors %}
                                            <ul class="list list--bare list--errors">
                                              {% for error in answer.errors %}
                                              <li class="list__item mars" {{helpers.errorTracking(question.id, error)}}>{{ error }}</li>
                                              {% endfor %}
                                            </ul>
                                            {% endif %}
                                          </div>
                                          <div class="alert__body">
                                            {{answer_fields|safe}}
                                          </div>
                                        </div>

                                        {{answer_guidance|safe}}

                                      {% else %}
                                        {{answer_fields|safe}}

                                        {{answer_guidance|safe}}

                                      {% endif %}
                                    </div>

                             </div>
                             {%- endfor -%}
                         </div>
                        {% endset %}

                        {% set question_actions %}
                          {%- if question.schema_item.type == 'RepeatingAnswer' %}
                          <div class="question__actions">
                            <button class="btn btn--border btn--secondary venus js-household-btn" type="submit"
                                  formaction="{{ url_for('action.add_answer',
                                    eq_id=meta.survey.eq_id,
                                    collection_id=meta.survey.collection_id,
                                    form_type=meta.survey.form_type,
                                    location=content.id,
                                    question=question.schema_item.id) }}"
                                  name="action[add_answer]">{{ _('Add another person') }}</button>
                          </div>
                          {%- endif %}
                        {% endset %}


                        <div class="question" id="{{question.id}}">

                          {% set question_markup %}

                            {% if question.answers|length > 1 %}

                              <fieldset class="question__fieldset">

                                <legend class="question__legend">
                                  {%- if question_title -%}
                                    <span class="question__title neptune">{{question_title}}</span>
                                  {%- endif %}
                                  {%- if question_subtitle -%}
                                    <br />
                                    <span class="question__subtitle venus">{{question_subtitle}}</span>
                                  {%- endif %}
                                </legend>

                                {{question_description|safe}}
                                {{question_answers|safe}}

                              </fieldset>

                            {% else %}

                              {{question_titles|safe}}
                              {{question_description|safe}}
                              {{question_answers|safe}}

                            {% endif %}

                          {% endset %}

                          {% if invalid %}

                            <div class="alert alert--simple alert--error">
                              <div class="alert__header">
                                {% if question.errors %}
                                <ul class="list list--bare list--errors">
                                  {% for error in question.errors %}
                                    <li class="list__item venus" {{helpers.errorTracking(question.id, error)}}>{{ error }}</li>
                                  {% endfor %}
                                </ul>
                                {% endif %}
                              </div>
                              <div class="alert__body">
                                {{question_markup|safe}}
                              </div>
                            </div>

                          {% else %}

                            {{question_markup|safe}}
                            {{question_actions|safe}}

                          {% endif %}

                        </div>

                    {% endif %}
                  {% endfor %}
                </div>


            {% endfor %}

            </div>

          </div>

      <button class="btn btn--secondary qa-btn-submit venus" type="submit" name="action[save_continue]">Save and continue</button>
      <br/>
      <div class="u-mt-xs">
        <a class="mars" href="{{previous_location}}">Previous</a>
      </div>

    </form>
  </div>
</div>

{% endblock %}
