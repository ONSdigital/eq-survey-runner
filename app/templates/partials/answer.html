{% import 'macros/helpers.html' as helpers %}

{% set invalid = form.errors[answer.id]|length > 0 %}

<div class="answer answer--{{answer.type|lower}} {{'js-has-errors' if invalid}}" id="{{answer.id}}">

  {% if render_guidance != False %}

  {%- set answer_guidance %}
    {% if answer.guidance %}
      {% with answer_guidance = {
        'id': answer.id,
        'label': answer.label,
        'content': answer.guidance
      } %}
        {% include 'partials/answer-guidance.html' %}
      {% endwith %}
    {% endif %}
  {% endset -%}

  {% endif %}

  {%- set answer_fields %}
    <div class="answer__fields">
      {% if answer.display and answer.display.properties %}
        {% set use_grid = answer.display.properties.columns %}
      {% endif %}
      {% include 'partials/answers/' ~ answer.type|lower ~ '.html' %}
    </div>
  {% endset -%}

  {% if form.errors[answer.id] %}

    <div class="panel panel--simple panel--error" data-qa="error">
      <div class="panel__header">
        <ul class="list list--bare list--errors">
            {% if form.errors[answer.id] is mapping %}
                {% for subfield_errors in form.errors[answer.id].values() %}
                    {% for subfield_error in subfield_errors %}
                        <li class="list__item mars" {{helpers.errorTracking(question.id, field_error)}}>{{ subfield_error }}</li>
                    {% endfor %}
                {% endfor %}
            {% elif form.errors[answer.id] is iterable %}
                {% for field_error in form.errors[answer.id] %}
                    <li class="list__item mars" {{helpers.errorTracking(question.id, field_error)}}>{{ field_error }}</li>
                {% endfor %}
            {% endif %}
        </ul>
      </div>
      <div class="panel__body" data-qa="error-body">
        {{answer_fields|safe}}
      </div>
    </div>

    {{answer_guidance|safe}}

  {% else %}
    {{answer_fields|safe}}
    {{answer_guidance|safe}}
  {% endif %}
</div>
