{% import 'macros/helpers.html' as helpers %}

{% set invalid = question.is_valid == False %}

{% set question_title = question.schema_item.title %}
{% set question_subtitle = question.schema_item.subtitle %}
{% set question_guidance = "" %}

{% set question_titles %}
  {%- if question_title -%}
    <h2 class="question__title neptune">{{question_title}}</h2>
  {%- endif %}
  {%- if question_subtitle -%}
    <br />
    <h3 class="question__subtitle mars">{{question_subtitle}}</h3>
  {%- endif -%}
{% endset %}

{% set question_description %}
  {%- if question.schema_item.description -%}
    <div class="question__description mars" id="description-{{question.id}}">
      {{question.schema_item.description|safe}}
    </div>
  {% endif %}
{% endset %}

{% set question_guidance %}
  {%- if question.schema_item.guidance -%}
    <div class="u-mb-s u-mb-l@s">
      <div class="alert alert--simple alert--neutral" id="question-guidance-{{question.id}}">
        {%- for guidance in question.schema_item.guidance -%}
          {%- if guidance.title -%}
            <h3 class="venus">{{guidance.title}}</h3>
          {% endif %}
          {%- if guidance.description -%}
            <div class="mars">{{guidance.description|safe}}</div>
          {% endif %}
          {%- if guidance.list -%}
            <ul class="mars">
              {%- for item in guidance.list -%}
                <li>{{item|safe}}</li>
              {% endfor %}
            </ul>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  {% endif %}
{% endset %}

{% set question_answers %}
 <div class="question__answers">
   {%- if question.schema_item.type == 'RepeatingAnswer' %}
     {%- for answer in question.answers %}
       <div class="question__answer js-household-person">
         <h3 class="neptune">{{ _('Person ') }}<span class="js-household-loopindex">{{ loop.index }}</span>
           <small>(
           {%- if loop.index == 1 -%}
              <span class="js-household-action">{{ _('You') }}</span>
           {%- else -%}
               <button class="btn btn--link" name="action[remove_answer]"
                       value="{{ loop.index0 }}">{{ _('Remove') }}
                   <span class="u-vh">{{ _('Person') }} {{loop.index0}}</span>
               </button>
           {%- endif -%}
           )</small>
         </h3>
         {% include theme('partials/answer.html') %}
       </div>
     {%- endfor %}
   {%- else %}
     {%- for answer in question.answers -%}
      <div class="question__answer">
       {% include theme('partials/answer.html') %}
     </div>
     {%- endfor -%}
   {%- endif %}
 </div>
{% endset %}

{% set question_actions %}
  {%- if question.schema_item.type == 'RepeatingAnswer' %}
  <div class="question__actions">
    <button class="btn btn--border btn--secondary venus js-household-btn" type="submit"
          name="action[add_answer]">{{ _('Add another person') }}</button>
  </div>
  {%- endif %}
{% endset %}


<div class="question" id="{{question.id}}">

  {% set question_markup %}

    {% if question.answers|length > 1 %}

      <fieldset class="question__fieldset">

        <legend class="question__legend">
          {%- if question_title -%}
            <span class="question__title neptune">{{question_title}}</span>
          {%- endif %}
          {%- if question_subtitle -%}
            <br />
            <span class="question__subtitle venus">{{question_subtitle}}</span>
          {%- endif %}
        </legend>

        {{question_description|safe}}
        {{question_guidance|safe}}
        {{question_answers|safe}}

      </fieldset>

    {% else %}

      {{question_titles|safe}}
      {{question_description|safe}}
      {{question_guidance|safe}}
      {{question_answers|safe}}

    {% endif %}

  {% endset %}

  {% if invalid %}

    <div class="alert alert--simple alert--error">
      <div class="alert__header">
        {% if question.errors %}
        <ul class="list list--bare list--errors">
          {% for error in question.errors %}
            <li class="list__item venus" {{helpers.errorTracking(question.id, error)}}>{{ error }}</li>
          {% endfor %}
        </ul>
        {% endif %}
      </div>
      <div class="alert__body">
        {{question_markup|safe}}
      </div>
    </div>

  {% else %}

    {{question_markup|safe}}
    {{question_actions|safe}}

  {% endif %}

</div>
